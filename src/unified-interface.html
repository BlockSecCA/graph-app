<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causal Graph Tool</title>
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/vis-network@latest/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.3/full/pyodide.js"></script>
    
    <!-- Application Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }

        /* Top Toolbar */
        .toolbar {
            height: 60px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .toolbar h1 {
            font-size: 18px;
            margin-right: 30px;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toolbar-section:not(:last-child) {
            margin-right: 30px;
            padding-right: 30px;
            border-right: 1px solid #34495e;
        }

        .toolbar button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar button:hover {
            background: #2980b9;
        }

        .toolbar button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .toolbar select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
            font-size: 14px;
        }

        .toolbar input[type="file"] {
            display: none;
        }

        .toolbar label {
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar label:hover {
            background: #229954;
        }

        .toolbar-input {
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            min-width: 80px;
        }

        .toolbar-input.small {
            min-width: 60px;
            max-width: 80px;
        }

        .toolbar-select {
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            min-width: 50px;
        }

        .toolbar button.danger {
            background: #e74c3c;
        }

        .toolbar button.danger:hover {
            background: #c0392b;
        }

        /* Main Content Area */
        .main-content {
            height: calc(100vh - 60px);
            display: flex;
        }

        /* Split Pane Container */
        .split-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Editor Pane */
        .editor-pane {
            flex: 1;
            min-width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            position: relative;  /* Ensure controls stay within pane */
        }

        .editor-header {
            padding: 15px 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #2c3e50;
        }


        .vis-network {
            flex: 1;
            width: 100%;
            background: white;
        }

        /* Resizable Splitter */
        .splitter {
            width: 5px;
            background: #bdc3c7;
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
        }

        .splitter:hover {
            background: #95a5a6;
        }

        .splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: #7f8c8d;
            border-radius: 2px;
        }

        /* Analysis Pane */
        .analysis-pane {
            flex: 1;
            min-width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .analysis-header {
            padding: 15px 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-header h2 {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .plugin-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .plugin-selector select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .run-analysis-btn {
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .run-analysis-btn:hover {
            background: #229954;
        }

        .run-analysis-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        /* Analysis Results */
        .analysis-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .analysis-results {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .analysis-results h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .analysis-results pre {
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            padding: 10px 15px;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .split-container {
                flex-direction: column;
            }
            
            .splitter {
                width: 100%;
                height: 5px;
                cursor: row-resize;
            }
            
            .editor-pane,
            .analysis-pane {
                min-width: unset;
                min-height: 300px;
            }
            
            .toolbar {
                flex-wrap: wrap;
                height: auto;
                min-height: 60px;
            }
            
            .toolbar-section {
                margin-right: 15px;
                padding-right: 15px;
            }
        }


        /* Hide elements when not needed */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Top Toolbar -->
    <div class="toolbar">
        <h1>Causal Graph Tool</h1>
        
        
        <div class="toolbar-section">
            <input type="text" id="node-id" placeholder="Node ID" class="toolbar-input" />
            <input type="text" id="node-label" placeholder="Label" class="toolbar-input" />
            <button id="add-node">Add Node</button>
            <button id="delete-node" class="danger">Delete Node</button>
        </div>
        
        <div class="toolbar-section">
            <input type="text" id="edge-source" placeholder="From" class="toolbar-input" />
            <input type="text" id="edge-target" placeholder="To" class="toolbar-input" />
            <select id="edge-type" class="toolbar-select">
                <option value="+">+</option>
                <option value="-">-</option>
            </select>
            <input type="number" id="edge-weight" placeholder="Weight" step="0.1" min="0" value="1" class="toolbar-input small" />
            <button id="add-edge">Add Edge</button>
            <button id="delete-edge" class="danger">Delete Edge</button>
        </div>
        
        <div class="toolbar-section">
            <span>Nodes: <span id="node-count">0</span></span>
            <span>Edges: <span id="edge-count">0</span></span>
        </div>
        
        <div class="toolbar-section">
            <button id="fit-graph">Fit Graph</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="split-container">
            <!-- Editor Pane -->
            <div class="editor-pane">
                <div class="editor-header">
                    <h2>Graph Editor</h2>
                </div>
                
                <!-- Graph Network (takes full space) -->
                <div id="editor-network" class="vis-network"></div>
            </div>

            <!-- Resizable Splitter -->
            <div class="splitter" id="splitter"></div>

            <!-- Analysis Pane -->
            <div class="analysis-pane">
                <div class="analysis-header">
                    <h2>Analysis</h2>
                    <div class="plugin-selector">
                        <select id="plugin-select">
                            <option value="causal-paths">Causal Path Analysis</option>
                            <option value="centrality" disabled>Centrality (Coming Soon)</option>
                            <option value="community" disabled>Community Detection (Coming Soon)</option>
                        </select>
                        <button id="run-analysis" class="run-analysis-btn">Analyze</button>
                    </div>
                </div>
                
                <!-- Analysis Content -->
                <div class="analysis-content">
                    <div id="analysis-placeholder" class="analysis-results">
                        <h3>Ready to Analyze</h3>
                        <p>Create a graph in the editor and click "Analyze" to see results.</p>
                        <p>Analysis will run automatically as you make changes to the graph.</p>
                    </div>
                    
                    <div id="analysis-loading" class="loading hidden">
                        Analyzing graph...
                    </div>
                    
                    <div id="analysis-results" class="analysis-results hidden">
                        <h3>Analysis Results</h3>
                        <div id="results-content"></div>
                    </div>
                    
                    <!-- Graph Visualization for Analysis -->
                    <div id="analysis-visualization" class="graph-container hidden" data-container-type="analysis" style="height: 300px; margin-top: 20px;">
                        <div id="analysis-network" class="vis-network"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages Container -->
    <div id="status-container"></div>

    <!-- Hidden file input for menu operations -->
    <input type="file" id="file-input" accept=".json" style="display: none;">

    <!-- Include Shared State -->
    <script src="shared-state.js"></script>

    <!-- Main Application Script -->
    <script>
        // Initialize the unified interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeUnifiedInterface();
            
            // Set up IPC listeners for menu commands
            if (window.require) {
                const { ipcRenderer } = window.require('electron');
                
                ipcRenderer.on('menu-new-graph', () => {
                    if (confirm('Create a new graph? This will clear the current graph.')) {
                        window.graphApp.updateGraph({ nodes: [], edges: [] });
                        showStatus('New graph created', 'info');
                    }
                });
                
                ipcRenderer.on('menu-load-graph', () => {
                    document.getElementById('file-input').click();
                });
                
                ipcRenderer.on('menu-save-graph', () => {
                    saveGraphFile();
                });
            }
        });

        async function initializeUnifiedInterface() {
            console.log('Initializing Causal Graph Tool...');
            
            // Initialize shared state
            const app = window.graphApp;
            
            // Initialize networks
            initializeEditorNetwork();
            initializeSplitter();
            initializeEventHandlers();
            
            // Initialize analysis system (placeholder for now)
            await initializeAnalysisSystem();
            
            console.log('Application initialized successfully');
        }

        function initializeEditorNetwork() {
            const container = document.getElementById('editor-network');
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 16,
                    font: { color: '#2c3e50', size: 14 },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 1.2 } },
                    smooth: { type: 'curvedCW', roundness: 0.1 },
                    font: { color: '#34495e', size: 12, align: 'middle' },
                    shadow: true
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: false
                },
                // Force vis-network to use full container size
                autoResize: true,
                width: '100%',
                height: '100%'
            };

            const editorNetwork = new vis.Network(container, { nodes: new vis.DataSet(), edges: new vis.DataSet() }, options);
            
            // Force resize to container dimensions
            function resizeNetwork() {
                const rect = container.getBoundingClientRect();
                editorNetwork.setSize(rect.width + 'px', rect.height + 'px');
                editorNetwork.fit();
            }
            
            // Initial resize
            setTimeout(resizeNetwork, 100);
            
            // Resize on window resize
            window.addEventListener('resize', resizeNetwork);
            
            // Register with shared state
            window.graphApp.registerNetwork('editor', editorNetwork);
            
            // Listen for graph updates
            window.graphApp.addEventListener('graphUpdated', (e) => {
                updateNetworkData(editorNetwork, e.detail.graph);
                updateStats(e.detail.graph);
            });
            
            // Handle network selection for easier editing
            editorNetwork.on('selectNode', function(params) {
                if (params.nodes.length > 0) {
                    document.getElementById('node-id').value = params.nodes[0];
                }
            });
            
            editorNetwork.on('selectEdge', function(params) {
                if (params.edges.length > 0) {
                    const edge = window.graphApp.state.currentGraph.edges.find(e => 
                        `${e.source}-${e.target}` === params.edges[0] || 
                        `${e.target}-${e.source}` === params.edges[0]
                    );
                    if (edge) {
                        document.getElementById('edge-source').value = edge.source;
                        document.getElementById('edge-target').value = edge.target;
                    }
                }
            });
        }

        function updateNetworkData(network, graphData) {
            const nodes = new vis.DataSet(graphData.nodes.map(node => ({
                id: node.id,
                label: node.label || node.id,
                group: node.group || 'default',
                title: `${node.label || node.id}\nType: ${node.type || 'N/A'}\nGroup: ${node.group || 'default'}`
            })));

            const edges = new vis.DataSet(graphData.edges.map(edge => ({
                id: `${edge.source}-${edge.target}`,
                from: edge.source,
                to: edge.target,
                label: edge.type + (edge.weight !== 1 ? ` (${edge.weight})` : ''),
                color: edge.type === '+' ? '#27ae60' : '#e74c3c',
                width: Math.abs(edge.weight) * 2,
                title: `${edge.source} → ${edge.target}\nType: ${edge.type}\nWeight: ${edge.weight}`
            })));

            network.setData({ nodes, edges });
        }

        function updateStats(graphData) {
            document.getElementById('node-count').textContent = graphData.nodes.length;
            document.getElementById('edge-count').textContent = graphData.edges.length;
        }

        function initializeSplitter() {
            const splitter = document.getElementById('splitter');
            const container = document.querySelector('.split-container');
            const editorPane = document.querySelector('.editor-pane');
            const analysisPane = document.querySelector('.analysis-pane');
            
            let isResizing = false;
            
            splitter.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = container.getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;
                
                // Calculate percentages
                const leftPercent = (x / containerWidth) * 100;
                const rightPercent = 100 - leftPercent;
                
                // Enforce minimum widths (30% each)
                if (leftPercent >= 30 && rightPercent >= 30) {
                    editorPane.style.flex = `0 0 ${leftPercent}%`;
                    analysisPane.style.flex = `0 0 ${rightPercent}%`;
                    
                    // Trigger network resize and control adaptation
                    setTimeout(() => {
                        const editorNetwork = window.graphApp.networks.editor;
                        const analysisNetwork = window.graphApp.networks.analysis;
                        
                        if (editorNetwork) {
                            const editorContainer = document.getElementById('editor-network');
                            const rect = editorContainer.getBoundingClientRect();
                            editorNetwork.setSize(rect.width + 'px', rect.height + 'px');
                            editorNetwork.fit();
                        }
                        if (analysisNetwork) {
                            analysisNetwork.fit();
                        }
                    }, 50);
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        function saveGraphFile() {
            try {
                const jsonData = window.graphApp.exportGraph();
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'graph.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Graph saved successfully', 'success');
            } catch (error) {
                showStatus(`Failed to save graph: ${error.message}`, 'error');
            }
        }

        function initializeEventHandlers() {
            // Node operations
            document.getElementById('add-node').addEventListener('click', () => {
                const id = document.getElementById('node-id').value.trim();
                const label = document.getElementById('node-label').value.trim();
                
                if (!id) {
                    showStatus('Please enter a node ID', 'error');
                    return;
                }
                
                try {
                    window.graphApp.addNode({ id, label: label || id });
                    document.getElementById('node-id').value = '';
                    document.getElementById('node-label').value = '';
                    showStatus(`Node "${id}" added successfully`, 'success');
                } catch (error) {
                    showStatus(error.message, 'error');
                }
            });

            document.getElementById('delete-node').addEventListener('click', () => {
                const id = document.getElementById('node-id').value.trim();
                
                if (!id) {
                    showStatus('Please enter a node ID to delete', 'error');
                    return;
                }
                
                try {
                    window.graphApp.deleteNode(id);
                    document.getElementById('node-id').value = '';
                    document.getElementById('node-label').value = '';
                    showStatus(`Node "${id}" deleted successfully`, 'success');
                } catch (error) {
                    showStatus(error.message, 'error');
                }
            });

            // Edge operations
            document.getElementById('add-edge').addEventListener('click', () => {
                const source = document.getElementById('edge-source').value.trim();
                const target = document.getElementById('edge-target').value.trim();
                const type = document.getElementById('edge-type').value;
                const weight = parseFloat(document.getElementById('edge-weight').value) || 1;
                
                if (!source || !target) {
                    showStatus('Please enter both source and target IDs', 'error');
                    return;
                }
                
                try {
                    window.graphApp.addEdge({ source, target, type, weight });
                    document.getElementById('edge-source').value = '';
                    document.getElementById('edge-target').value = '';
                    document.getElementById('edge-weight').value = '1';
                    showStatus(`Edge "${source} → ${target}" added successfully`, 'success');
                } catch (error) {
                    showStatus(error.message, 'error');
                }
            });

            document.getElementById('delete-edge').addEventListener('click', () => {
                const source = document.getElementById('edge-source').value.trim();
                const target = document.getElementById('edge-target').value.trim();
                
                if (!source || !target) {
                    showStatus('Please enter both source and target IDs to delete edge', 'error');
                    return;
                }
                
                try {
                    window.graphApp.deleteEdge(source, target);
                    document.getElementById('edge-source').value = '';
                    document.getElementById('edge-target').value = '';
                    showStatus(`Edge "${source} → ${target}" deleted successfully`, 'success');
                } catch (error) {
                    showStatus(error.message, 'error');
                }
            });

            // File operations
            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        window.graphApp.importGraph(event.target.result);
                        showStatus(`Graph loaded from "${file.name}"`, 'success');
                    } catch (error) {
                        showStatus(`Failed to load graph: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            });

            // File operations (now handled by menu, but keeping for compatibility)
            // These elements no longer exist in toolbar but IDs might be referenced elsewhere

            // Graph operations
            document.getElementById('fit-graph').addEventListener('click', () => {
                const network = window.graphApp.networks.editor;
                if (network) {
                    network.fit();
                }
            });

            // Analysis operations
            document.getElementById('run-analysis').addEventListener('click', () => {
                window.graphApp.triggerAnalysis();
            });

            // Listen for analysis events
            window.graphApp.addEventListener('analysisStarted', () => {
                document.getElementById('analysis-loading').classList.remove('hidden');
                document.getElementById('analysis-results').classList.add('hidden');
                document.getElementById('run-analysis').disabled = true;
            });

            window.graphApp.addEventListener('analysisCompleted', (e) => {
                document.getElementById('analysis-loading').classList.add('hidden');
                document.getElementById('analysis-results').classList.remove('hidden');
                document.getElementById('run-analysis').disabled = false;
                
                displayAnalysisResults(e.detail.results);
            });

            window.graphApp.addEventListener('analysisError', (e) => {
                document.getElementById('analysis-loading').classList.add('hidden');
                document.getElementById('run-analysis').disabled = false;
                showStatus(`Analysis failed: ${e.detail.error}`, 'error');
            });
        }

        async function initializeAnalysisSystem() {
            console.log('Initializing Pyodide for Python analysis...');
            
            try {
                // Load Pyodide and networkx
                window.pyodideInstance = await loadPyodide();
                await window.pyodideInstance.loadPackage('networkx');
                
                // Load the Python analysis code
                const response = await fetch('../py/test_pyodide.py');
                if (!response.ok) {
                    throw new Error(`Failed to load Python analysis: ${response.status}`);
                }
                window.analysisCode = await response.text();
                
                console.log('Pyodide and analysis code loaded successfully');
                
                // Real Python analysis plugin
                window.graphApp.state.availablePlugins.set('causal-paths', {
                    analyze: async (graph, params) => {
                        if (!window.pyodideInstance || !window.analysisCode) {
                            throw new Error('Python analysis system not initialized');
                        }
                        
                        if (graph.nodes.length === 0) {
                            throw new Error('No nodes in graph to analyze');
                        }
                        
                        try {
                            // Set graph data in Pyodide globals
                            const graphData = {
                                nodes: graph.nodes,
                                edges: graph.edges
                            };
                            
                            window.pyodideInstance.globals.set("GraphData", graphData);
                            
                            // Run the Python analysis
                            const result = await window.pyodideInstance.runPythonAsync(window.analysisCode);
                            
                            // Convert result to JavaScript object
                            const jsResult = result.toJs ? result.toJs() : result;
                            
                            return {
                                metadata: {
                                    analysis_id: 'causal-paths',
                                    analysis_name: 'Causal Path Analysis',
                                    timestamp: new Date().toISOString(),
                                    parameters_used: params,
                                    graph_stats: {
                                        nodes: graph.nodes.length,
                                        edges: graph.edges.length
                                    }
                                },
                                results: {
                                    primary: {
                                        influence_scores: jsResult.influence_scores || {},
                                        positive_paths: jsResult.positive_paths || [],
                                        negative_paths: jsResult.negative_paths || []
                                    }
                                },
                                summary: formatAnalysisSummary(jsResult)
                            };
                            
                        } catch (error) {
                            console.error('Python analysis error:', error);
                            throw new Error(`Analysis failed: ${error.message}`);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Failed to initialize analysis system:', error);
                
                // Fallback to basic analysis if Python fails
                window.graphApp.state.availablePlugins.set('causal-paths', {
                    analyze: async (graph, params) => {
                        return {
                            metadata: {
                                analysis_id: 'causal-paths-fallback',
                                timestamp: new Date().toISOString()
                            },
                            results: {
                                primary: {
                                    error: 'Python analysis unavailable',
                                    basic_stats: {
                                        node_count: graph.nodes.length,
                                        edge_count: graph.edges.length
                                    }
                                }
                            },
                            summary: `Basic analysis: ${graph.nodes.length} nodes, ${graph.edges.length} edges. Python analysis unavailable.`
                        };
                    }
                });
            }
        }
        
        function formatAnalysisSummary(results) {
            const lines = [];
            
            if (results.influence_scores) {
                const scores = Object.entries(results.influence_scores);
                if (scores.length > 0) {
                    const topNode = scores.reduce((a, b) => a[1] > b[1] ? a : b);
                    lines.push(`Highest influence: ${topNode[0]} (${topNode[1]})`);
                }
            }
            
            if (results.positive_paths && results.positive_paths.length > 0) {
                lines.push(`Found ${results.positive_paths.length} positive path(s)`);
            }
            
            if (results.negative_paths && results.negative_paths.length > 0) {
                lines.push(`Found ${results.negative_paths.length} negative path(s)`);
            }
            
            return lines.length > 0 ? lines.join('. ') + '.' : 'Analysis completed successfully.';
        }

        function displayAnalysisResults(results) {
            const container = document.getElementById('results-content');
            
            let html = `<div style="margin-bottom: 15px;"><strong>Summary:</strong> ${results.summary}</div>`;
            
            if (results.results && results.results.primary) {
                const primary = results.results.primary;
                
                // Display influence scores
                if (primary.influence_scores && Object.keys(primary.influence_scores).length > 0) {
                    html += `<div style="margin-bottom: 15px;">
                        <strong>Influence Scores:</strong>
                        <div style="margin-left: 10px;">`;
                    
                    Object.entries(primary.influence_scores).forEach(([node, score]) => {
                        html += `<div>${node}: ${score}</div>`;
                    });
                    html += `</div></div>`;
                }
                
                // Display positive paths
                if (primary.positive_paths && primary.positive_paths.length > 0) {
                    html += `<div style="margin-bottom: 15px;">
                        <strong>Positive Paths:</strong>
                        <div style="margin-left: 10px;">`;
                    
                    primary.positive_paths.forEach(path => {
                        html += `<div>${path.join(' → ')}</div>`;
                    });
                    html += `</div></div>`;
                }
                
                // Display negative paths
                if (primary.negative_paths && primary.negative_paths.length > 0) {
                    html += `<div style="margin-bottom: 15px;">
                        <strong>Negative Paths:</strong>
                        <div style="margin-left: 10px;">`;
                    
                    primary.negative_paths.forEach(path => {
                        html += `<div>${path.join(' → ')}</div>`;
                    });
                    html += `</div></div>`;
                }
                
                // If no meaningful results, show raw data
                if (!primary.influence_scores && !primary.positive_paths && !primary.negative_paths) {
                    html += `<div><strong>Raw Results:</strong>
                        <pre style="font-size: 12px;">${JSON.stringify(primary, null, 2)}</pre></div>`;
                }
            }
            
            container.innerHTML = html;
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
            
            container.appendChild(statusDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const editorNetwork = window.graphApp.networks.editor;
            const analysisNetwork = window.graphApp.networks.analysis;
            
            if (editorNetwork) {
                editorNetwork.fit();
            }
            if (analysisNetwork) {
                analysisNetwork.fit();
            }
        });
    </script>
</body>
</html>